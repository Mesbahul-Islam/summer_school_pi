<!DOCTYPE html>
<html>
<head>
    <title>Sensor Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f8f9fa; padding: 20px; }
        canvas { max-width: 800px; margin: 20px auto; display: block; }
    </style>
</head>
<body>
    <h1>Live Sensor Dashboard</h1>

    <canvas id="group3distanceChart"></canvas>
    <canvas id="group3motionChart"></canvas>
    <canvas id="group2distanceChart"></canvas>
    <canvas id="group2motionChart"></canvas>
    <canvas id="group1distanceChart"></canvas>
    <canvas id="group1motionChart"></canvas>

    <script>
// Chart creation helper with improved options
const createLineChart = (ctx, label, borderColor, fill = false, stepped = false) => new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label,
            data: [],
            borderColor,
            backgroundColor: fill ? borderColor + '33' : 'transparent', // semi-transparent fill
            fill,
            pointRadius: 4,
            pointHoverRadius: 6,
            stepped: stepped,
            tension: fill ? 0.3 : 0 // smooth for distance, stepped for motion
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: true, position: 'top' },
            title: { display: true, text: label },
            tooltip: { enabled: true, mode: 'index', intersect: false }
        },
        scales: {
            x: {
                grid: { display: true, color: '#e0e0e0' }
            },
            y: {
                beginAtZero: true,
                grid: { display: true, color: '#e0e0e0' },
                ticks: label.includes('Motion') ? { stepSize: 1, max: 1, min: 0 } : {}
            }
        }
    }
});

// Distance charts: filled, smooth
const group3distanceChart = createLineChart(group3distanceCtx, 'Group 3 Distance (cm)', 'blue', true);
const group2distanceChart = createLineChart(group2distanceCtx, 'Group 2 Distance (cm)', 'green', true);
const group1distanceChart = createLineChart(group1distanceCtx, 'Group 1 Distance (cm)', 'purple', true);

// Motion charts: stepped, no fill
const group3motionChart = createLineChart(group3motionCtx, 'Group 3 Motion', 'red', false, true);
const group2motionChart = createLineChart(group2motionCtx, 'Group 2 Motion', 'orange', false, true);
const group1motionChart = createLineChart(group1motionCtx, 'Group 1 Motion', 'brown', false, true);

const MAX_DATA_POINTS = 10;

async function fetchData() {
    try {
        const response = await fetch("/data");
        const data = await response.json();

        const now = new Date().toLocaleTimeString();

        function updateChart(chart, time, value, isMotion = false) {
            chart.data.labels.push(time);
            chart.data.datasets[0].data.push(isMotion ? (value ? 1 : 0) : value || 0);

            if (chart.data.labels.length > MAX_DATA_POINTS) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            chart.update('none');
        }

        if (data.group3) {
            updateChart(group3distanceChart, data.group3.time || now, data.group3.distance);
            updateChart(group3motionChart, data.group3.time || now, data.group3.motion, true);
        }

        if (data.group2_ultrasonic) {
            updateChart(group2distanceChart, data.group2_ultrasonic.time || now, data.group2_ultrasonic.distance);
        }
        if (data.group2_pir) {
            updateChart(group2motionChart, data.group2_pir.time || now, data.group2_pir.motion, true);
        }

        if (data.group1) {
            updateChart(group1distanceChart, now, data.group1.distance);
            updateChart(group1motionChart, now, data.group1.motion, true);
        }

    } catch (err) {
        console.error("Failed to fetch or update sensor data:", err);
    }
}

setInterval(fetchData, 1000);
fetchData();
</script>

</body>
</html>